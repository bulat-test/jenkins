
def docker_hub_project = 'dgls/footcourtproxy-'

def function(version) {
    deleteDir()
    withCredentials([string(credentialsId: '7c62eff2-ed2e-4ee0-be37-2bbd5b127984', variable: 'TOKEN')]){
    sh "whoami"
    sh "hostname"
    echo ("Env: "+docker_hub_project)
    //    echo userInput
    //    sh "echo $userInput"

    sh "echo \"docker `uname -m`:latest\""
    echo "Сборщик: ${env.NODE_NAME}"
    echo "Директория: ${env.WORKSPACE}"
    echo "Версия Docker"
    sh "docker -v"

    checkout scm

    sh " VERSION=$version ./docker/build.sh  "
    sh "docker tag dgls/footcourtproxy-`uname -m`:$version dgls/footcourtproxy-`uname -m`:latest"
    sh "docker images"
    sh "docker rmi --no-prune \$(docker images --filter=reference=\"dgls/footcourtproxy-*\" -q)"
    }
}

stage ('promotion'){
    def userInput = input(
     id: 'userInput', message: 'Enter the version that will be created', parameters: [
     [$class: 'TextParameterDefinition', defaultValue: '1.0.0', description: 'Version', name: 'Version']
    ])
    
     parallel (
         "stream x86_64" : {
             node('x86_64') {
                 function(userInput)
             }
         },

         "stream armv7l" : { 
             node('arm') {
                 function(userInput)
             }
         }
     )


}
