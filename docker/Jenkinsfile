
def function() {
        def host_arch = sh (script: 'uname -m', returnStdout: true).trim()
        def docker_hub_project = ("dgls/footcourtproxy-" + host_arch)
    stage ('init'){
        deleteDir()  
        echo "Сборщик: ${env.NODE_NAME}"
        echo "Директория: ${env.WORKSPACE}"
        echo "Версия Docker"
        sh "docker -v"
        echo ("Собираемый контейнер: "+docker_hub_project +":"+VERSION)

        checkout scm
    }
    stage ('build'){
        sh "./docker/build.sh"
    }
    
    stage ('push'){
        sh "docker tag $docker_hub_project:$VERSION $docker_hub_project:latest"
        sh "docker images"

        withCredentials([string(credentialsId: '7c62eff2-ed2e-4ee0-be37-2bbd5b127984', variable: 'TOKEN')]){
            // docker login
        }

        // docker push

        try {
            sh "docker rmi -f  \$(docker images $docker_hub_project -q)"
        } catch ( e ) {
         echo  "can not remove some images"
        }
    }
    
}

  
parallel (
    "stream x86_64" : {
        node('x86_64') {
            function()
        }
    },

    "stream armv7l" : { 
        node('arm') {
            function()
        }
    }
)

